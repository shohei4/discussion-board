<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>議題登録</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container d-flex justify-content-center align-items-center" style="min-height: 100vh;">
    <div class="card shadow p-4" style="width: 100%; max-width: 500px; border-radius: 1rem;">
        <h3 class="text-center mb-4">議題登録</h3>

        <!-- メッセージ表示 -->
        <div id="message" class="d-none text-center fw-bold mb-3"></div>

        <form id="gidaiForm">
            <div class="mb-3">
                <label for="gidai" class="form-label">議題名</label>
                <textarea type="text" class="form-control" id="gidai" name="gidai" placeholder="議題名を入力" required></textarea>
            </div>

            <div class="mb-3">
                <label for="genre" class="form-label">ジャンル</label>
				<select id="genre" name="genre" class="form-select">
				  <option value="" disabled selected>選択してください</option>
				  <th:block th:each="genre : ${genres}">
					<option th:value="${genre.label}" th:text="${genre.label}"></option>
				  </th:block>
				</select>
            </div>

            <!-- 投稿者IDはログインユーザーのIDを非表示で送信 -->
            <input type="hidden" id="userId" name="userId" value="1">

            <div class="d-grid">
                <button type="submit" class="btn btn-primary">登録</button>
            </div>
        </form>
    </div>
</div>

<script>
    const form = document.getElementById('gidaiForm');
    const messageDiv = document.getElementById('message');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const data = {
            gidai: document.getElementById('gidai').value,
            genre: document.getElementById('genre').value,
            userId: document.getElementById('userId').value
        };
				
        try {
			const token = sessionStorage.getItem('jwt');
			
            const response = await fetch('/api/gidai', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
			
			
            if (response.ok) {
                const result = await response.json();
                sessionStorage.setItem(
					'successMessage', 
					`登録成功: ${result.gidai} (${result.genre})`
				);
                window.location.href = '/view/gidai/list';
            } else {
                messageDiv.className = 'mt-3 text-center fw-bold text-danger';
                messageDiv.innerText = `登録に失敗しました (${response.status})`;
                messageDiv.classList.remove('d-none');
            }
        } catch (error) {
            messageDiv.className = 'mt-3 text-center fw-bold text-danger';
            messageDiv.innerText = '通信エラーが発生しました';
            messageDiv.classList.remove('d-none');
        }
    });
</script>

</body>
</html>
