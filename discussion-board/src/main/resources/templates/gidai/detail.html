<!DOCTYPE html>
<html xmlns="">

<head>
	<meta charset="UTF-8">
	<title>Insert title here</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

</head>

<body>
	<div class="container my-5">

		<!-- è­°é¡Œã‚«ãƒ¼ãƒ‰ -->
		<div class="card shadow-sm mb-4">
			<div class="card-body">

				<!-- ã‚¿ã‚¤ãƒˆãƒ« -->
				<h2 id="title" class="card-title fw-bold mb-3">
					è­°é¡Œã‚¿ã‚¤ãƒˆãƒ«
				</h2>

				<!-- æœ¬æ–‡ -->
				<p id="body" class="card-text fs-5 mb-4">
					æœ¬æ–‡
				</p>

				<!-- ä½œæˆè€… -->
				<p class="text-muted mb-4">
					ä½œæˆè€…ï¼š
					<span id="username" class="fw-semibold"></span>
				</p>

				<!-- æ“ä½œãƒœã‚¿ãƒ³ -->
				<div class="d-flex gap-2">
					<a id="EditGidaiLink" class="btn btn-outline-warning">
						<i class="bi bi-pencil-square"></i> ç·¨é›†
					</a>

					<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#commentModal">
						<i class="bi bi-chat-dots"></i> ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
					</button>
				</div>
			</div>
		</div>

		<!-- è­°é¡ŒIDï¼ˆJSç”¨ï¼‰ -->
		<div id="gidai-data" th:attr="data-gidai-id=${gidaiId}"></div>

		<!-- ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ -->
		<div class="card shadow-sm">
			<div class="card-header bg-light fw-bold">
				è­°è«–ã‚³ãƒ¡ãƒ³ãƒˆ
			</div>

			<div id="commentList" class="list-group list-group-flush">
				<!-- JSã§ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ  -->
			</div>
		</div>

	</div>

	<!-- ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ãƒ¢ãƒ¼ãƒ€ãƒ« -->
	<div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="commentModalLabel">ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
				</div>
				<div class="modal-body">
					<textarea id="modalComment" class="form-control" rows="3" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›"></textarea>
					<div id="modalMessage" class="text-danger fw-bold mt-2"></div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
					<button type="button" class="btn btn-primary" id="submitModalComment">æŠ•ç¨¿</button>
				</div>
			</div>
		</div>
	</div>

	</div>

	<script src="/js/apiClient.js"></script>
	<script>
		const API_BASE = "http://localhost:8080/api/discussion"

		//è­°é¡Œå–å¾—ãƒ¡ã‚½ãƒƒãƒ‰
		async function loadGidaiResponse(gidaiId) {
			const response = await authenticatedFetch(`/api/gidai/${gidaiId}`); // èªè¨¼ä»˜ãfetch
			if (!response.ok) return;
			return await response.json();
		}

		//è­°é¡Œè¡¨ç¤ºmethod
		function renderGidaiResponse(gidaiItemResponse) {
			document.getElementById('title').innerText = gidaiItemResponse.title;
			document.getElementById('body').innerText = gidaiItemResponse.body;
			document.getElementById('username').innerText = gidaiItemResponse.userSummary.username
		}

		//ã‚³ãƒ¡ãƒ³ãƒˆDOMè¿½åŠ ãƒ¡ã‚½ãƒƒãƒ‰
		function appendComment(item) {
			const list = document.getElementById('commentList');
			//ã‚³ãƒ¡ãƒ³ãƒˆ1ä»¶ç”¨ã®divä½œæˆ
			const div = document.createElement('div');
			div.className = "list-group-item comment-item";
			div.dataset.commentId = item.id;
			div.innerHTML = `
			<strong>${item.userSummary.username}</strong>
			<br>${item.comment}
			<br><small>${item.createdAt}</small>
			<button class="like-toggle-btn btn btn-sm btn-outline-primary mt-2">
				ğŸ‘ ã„ã„ã­ <span class="like-count">${item.likeCount || 0}</span>
			</button>
			`;
			list.prepend(div);
		}

		//ç”»é¢è¡¨ç¤ºæ™‚ã®å‡¦ç†
		document.addEventListener("DOMContentLoaded", async () => {
			const gidaiId = document.getElementById("gidai-data").dataset.gidaiId;
			const [gidaiItemResponse, discussionItemResponses] = await Promise.all([
				loadGidaiResponse(gidaiId),
				loadComments(gidaiId)
			]);

			renderGidaiResponse(gidaiItemResponse);
			discussionItemResponses.forEach(appendComment);

			const modalEl = document.getElementById('commentModal');
			modalEl.addEventListener('shown.bs.modal', () => {
				document.getElementById('modalComment').focus();
			});
		});

		//ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§è¡¨ç¤º
		async function loadComments(gidaiId) {
			const response = await authenticatedFetch(`${API_BASE}/list/${gidaiId}`);
			if (!response.ok) return [];
			return await response.json();
		}

		// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
		document.getElementById('submitModalComment').addEventListener("click", async () => {
			const comment = document.getElementById('modalComment').value;
			const gidaiId = document.getElementById("gidai-data").dataset.gidaiId;
			const token = sessionStorage.getItem('accessToken');

			if (!token) {
				document.getElementById('modalMessage').innerText = "ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™";
				return;
			}
			if (!comment) {
				document.getElementById('modalMessage').innerText = "ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
				return;
			}

			try {
				//POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆ
				const response = await authenticatedFetch(`${API_BASE}/save/${gidaiId}`, {
					method: "POST",
					headers: {"Content-Type": "application/json"},
					body: JSON.stringify({comment})
				});
				if (!response.ok) throw new Error("æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ");

				const data = await response.json();
				appendComment(data);

				document.getElementById('modalComment').value = "";
				document.getElementById('modalMessage').innerText = "";

				// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
				const modal = bootstrap.Modal.getInstance(document.getElementById('commentModal'));
				modal.hide();

			} catch (err) {
				document.getElementById('modalMessage').innerText = err.message;
			}
		});

		//ãƒˆã‚°ãƒ«å‡¦ç†é–¢æ•°
		async function toggleStatus(id, btnElement) {
			//äºŒé‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢
			btnElement.disabled = true;

			try {
				//1. APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
				const response = await authenticatedFetch(`/api/like/toggle/${id}`, {
					method: "POST"
				});
				if (!response.ok) throw new Error('å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');

				//2. ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã£ã¦ããŸæœ€æ–°ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—
				const data = await response.json();

				//3. UIã®ãƒˆã‚°ãƒ«å‡¦ç†
				//ã„ã„ã­æ•°ã®è¡¨ç¤ºä½ç½®ã®æŒ‡å®šã®ãªã„å ´åˆã®å‡¦ç†
				const countSpan = btnElement.querySelector('.like-count');
				if (countSpan && data.likeCount !== undefined) {
					countSpan.innerText = data.likeCount;
				}

				//Bootstrapã®ã‚¯ãƒ©ã‚¹ã‚’å…¥ã‚Œæ›¿ãˆã¦è‰²ã‚’å¤‰ãˆã‚‹
				if (data.isLiked) {
					btnElement.classList.replace('btn-outline-primary', 'btn-primary');
				} else {
					btnElement.classList.replace('btn-primary', 'btn-outline-primary');
				}

			} catch {
				console.error('Error:', error);
				alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã‹ã€é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
			} finally {
				//4. ãƒœã‚¿ãƒ³ã®å†åº¦æœ‰åŠ¹åŒ–
				btmElement.disabled = false;
			}
		}
		
		// âœ… ã„ã„ã­ãƒœã‚¿ãƒ³ã®ãƒˆã‚°ãƒ«å‡¦ç†ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
		document.getElementById('commentList').addEventListener('click', (e) => {
		    // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ç´ ã®è¿‘ãã«ã€Œã„ã„ã­ãƒœã‚¿ãƒ³ã€ãŒã‚ã‚‹ã‹åˆ¤å®š
		    const btn = e.target.closest('.like-toggle-btn');
		    
		    if (btn) {
		        // ãƒœã‚¿ãƒ³ã®è¦ªï¼ˆcomment-itemï¼‰ã‹ã‚‰IDã‚’å–å¾—
		        const commentItem = btn.closest('.comment-item');
		        const commentId = commentItem.dataset.commentId;
		        
		        // ä»¥å‰ä½œæˆã—ãŸ toggleStatus é–¢æ•°ã‚’å‘¼ã³å‡ºã™
		        // btn ã‚’å¼•æ•°ã«æ¸¡ã™ã“ã¨ã§ã€é–¢æ•°å†…ã§ãƒœã‚¿ãƒ³ã®è‰²ã‚’å¤‰ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™
		        toggleStatus(commentId, btn);
		    }
		});

	</script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>

</html>