<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="UTF-8">
	<title>議題一覧</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<style>
		/* 複数行省略用クラス */
		.multiline-truncate {
			display: -webkit-box;
			-webkit-line-clamp: 3;
			/* 最大行数 */
			-webkit-box-orient: vertical;
			overflow: hidden;
			text-overflow: ellipsis;
			
			/* 追加 */
			white-space: normal;
			/* nowrap を解除 */
			word-break: break-word;
			/* 単語が長すぎても折り返す */
		}
	</style>
</head>

<body>
	<!-- 議題登録成功メッセージの表示 -->
	<div id="success-message" class="alert alert-success d-none text-center" role="alert"></div>
	<div class="container mt-5">
		<h2 class="mb-4">議題一覧</h2>
		<table class="table table-striped table-hover" id="gidaiTable">
			<thead class="table-dark">
				<tr>
					<th>ID</th>
					<th>タイトル</th>
					<th>本文</th>
					<th>ジャンル</th>
					<th>作成者</th>
					<th></th>
				</tr>
			</thead>
			<tbody>
				<!-- JavaScriptで挿入 -->
			</tbody>
		</table>
		<a th:href="@{/view/gidai/registration}">新規登録はこちら</a>
	</div>
	
	<script src="/js/apiClient.js"></script>
	<script>
	    // 文字列を指定文字数で切り詰める関数
	    function truncate(str, maxLength) {
	        if (!str) return "";
	        return str.length > maxLength ? str.substring(0, maxLength) + "…" : str;
	    }
	
	    window.addEventListener('DOMContentLoaded', async () => {
	        // 1️⃣ メッセージ表示（変更なし）
	        const message = sessionStorage.getItem('successMessage');
	        if (message) {
	            const messageDiv = document.getElementById('success-message');
	            if (messageDiv) {
	                messageDiv.innerText = message;
	                messageDiv.classList.remove('d-none');
	            }
	            sessionStorage.removeItem('successMessage');
	        }
	
	        // 2️⃣ Gidai データ取得
	        const tbody = document.querySelector('#gidaiTable tbody');
	        if (!tbody) return;
	
	        try {
	            // ★ 自前のfetchWithRefreshを消して、共通のauthenticatedFetchを使う
	            const response = await authenticatedFetch('/api/gidai');
	            
	            if (!response.ok) {
	                throw new Error('データの取得に失敗しました');
	            }
	
	            const data = await response.json();
	            
	            data.forEach(gidai => {
	                const tr = document.createElement('tr');
	                tr.innerHTML = `
	                    <td>${gidai.id}</td>
	                    <td>${truncate(gidai.title, 20)}</td>
	                    <td><div class="multiline-truncate">${gidai.body}</div></td>
	                    <td>${gidai.genre}</td>
	                    <td>${gidai.userSummary?.username || ''}</td>
	                    <td><a href="/view/gidai/detail/${gidai.id}">詳細</a></td>
	                `;
	                tbody.appendChild(tr);
	            });
	        } catch (err) {
	            console.error("エラーが発生しました:", err);
	            // 必要に応じてユーザーにエラーを通知する処理
	        }
	    });
	</script>


	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>