<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="UTF-8">
	<title>議題一覧</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<style>
		/* 複数行省略用クラス */
		.multiline-truncate {
			display: -webkit-box;
			-webkit-line-clamp: 3;
			/* 最大行数 */
			-webkit-box-orient: vertical;
			overflow: hidden;
			text-overflow: ellipsis;
			
			/* 追加 */
			white-space: normal;
			/* nowrap を解除 */
			word-break: break-word;
			/* 単語が長すぎても折り返す */
		}
	</style>
</head>

<body>
	<!-- 議題登録成功メッセージの表示 -->
	<div id="success-message" class="alert alert-success d-none text-center" role="alert"></div>
	<div class="container mt-5">
		<h2 class="mb-4">議題一覧</h2>
		<table class="table table-striped table-hover" id="gidaiTable">
			<thead class="table-dark">
				<tr>
					<th>ID</th>
					<th>タイトル</th>
					<th>本文</th>
					<th>ジャンル</th>
					<th>作成者</th>
					<th></th>
				</tr>
			</thead>
			<tbody>
				<!-- JavaScriptで挿入 -->
			</tbody>
		</table>
		<a th:href="@{/view/gidai/registration}">新規登録はこちら</a>
	</div>

	<script>

		// 文字列を指定文字数で切り詰める関数
		function truncate(str, maxLength) {
			if (!str) return "";
			return str.length > maxLength ? str.substring(0, maxLength) + "…" : str;
		}

		window.addEventListener('DOMContentLoaded', async () => {
			// 1️⃣ メッセージ表示
			const message = sessionStorage.getItem('successMessage');
			if (message) {
				const messageDiv = document.getElementById('success-message');
				if (messageDiv) {
					messageDiv.innerText = message;
					messageDiv.classList.remove('d-none');
				}
				sessionStorage.removeItem('successMessage');
			}

			// 2️⃣ Gidai データ取得
			const tbody = document.querySelector('#gidaiTable tbody');
			if (!tbody) return;

			async function fetchWithRefresh(url) {
				let accessToken = sessionStorage.getItem('accessToken');
				let res = await fetch(url, {
					headers: {'Authorization': `Bearer ${accessToken}`}
				});

				if (res.status === 401) {
					// アクセストークン切れ → リフレッシュ
					const refreshToken = sessionStorage.getItem('refreshToken');

					const refreshRes = await fetch('/api/refresh', {
						method: 'POST',
						headers: {'Content-Type': 'application/json'},
						body: JSON.stringify({plainRefreshToken: refreshToken})
					});

					if (!refreshRes.ok) {
						window.location.href = '/login';
						throw new Error('Refresh failed');
					}

					const data = await refreshRes.json();

					// 新しいトークンを保存
					sessionStorage.setItem('accessToken', data.accessToken);
					sessionStorage.setItem('refreshToken', data.plainRefreshToken);
					sessionStorage.setItem('refreshTokenExpiresAt', data.refreshTokenExpiresAt);

					// 再リクエスト
					res = await fetch(url, {
						headers: {'Authorization': `Bearer ${data.accessToken}`}
					});
				}

				return res.json();
			}

			try {
				const data = await fetchWithRefresh('/api/gidai');
				data.forEach(gidai => {
					const tr = document.createElement('tr');
					tr.innerHTML = `
	                <td>${gidai.id}</td>
					<td>${truncate(gidai.title, 20)}</td> <!-- タイトルは20文字で切る -->
					<td><div class="multiline-truncate">${gidai.body}</div></td> <!-- 本文はCSSで省略 -->
	                <td>${gidai.genre}</td>
	                <td>${gidai.userSummary?.username || ''}</td>
	                <td><a href="/view/gidai/detail/${gidai.id}">詳細</a></td>
	            `;
					tbody.appendChild(tr);
				});
			} catch (err) {
				console.error(err);
			}
		});
	</script>


	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>